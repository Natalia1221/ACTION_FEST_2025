<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Fest - Souvenir Recipient List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Config (optional, but good practice)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {} // Keep empty or extend as needed
                }
            }
        }
    </script>
    <style>
        /* CSS Variables for Theme Colors */
        :root {
            --color-primary-500: #004c4c;
            --color-primary-600: #004c4c;
            --color-primary-700: #00645f;
            --color-primary-800: #00645f;
        }

        /* Base Button Style */
        .btn {
            padding: 0.3rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, opacity 0.15s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
            cursor: pointer;
            line-height: 1.25;
            white-space: nowrap;
        }

        /* Primary Button Style */
        .btn-primary {
            background-color: var(--color-primary-600);
            color: white;
            border-color: var(--color-primary-600);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-primary-700);
            border-color: var(--color-primary-700);
        }

        /* Disabled/Completed Button Style */
        .btn-disabled {
            background-color: #d1d5db;
            color: #6b7280;
            border-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Link Style */
        .link-primary {
            color: var(--color-primary-600);
            text-decoration: none;
        }

        .link-primary:hover {
            color: var(--color-primary-500);
            text-decoration: underline;
        }

        .text-primary-700 {
            color: var(--color-primary-700);
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-image: url('Assets/Gunung PNG-01.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-color: #f3f4f6;
            padding-top: 80px;
            color: #1f2937;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header Home Button Icon */
        .home-button-icon svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Table Styling */
        .table-container {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: white;
        }

        table {
            min-width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
            word-wrap: break-word;
        }

        /* Header cell styling */
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Data cell styling */
        td {
            font-size: 0.875rem;
            color: #1f2937;
        }

        /* Remove bottom border from last row */
        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Style for rows marked as done */
        tr.row-done {
            background-color: #f9fafb;
            opacity: 0.8;
        }

        tr.row-done td {
            color: #6b7280;
        }

        /* Column Widths (Example - Adjust as needed) */
        table th:nth-child(1),
        table td:nth-child(1) {
            width: 15%;
        }

        /* Name */
        table th:nth-child(2),
        table td:nth-child(2) {
            width: 30%;
        }

        /* School */
        table th:nth-child(3),
        table td:nth-child(3) {
            width: 25%;
        }

        /* Category */
        table th:nth-child(4),
        table td:nth-child(4) {
            width: 20%;
        }

        /* Action */
        table th:nth-child(5),
        table td:nth-child(5) {
            width: 10%;
            text-align: center;
        }

        /* Loading/Error Message Styling */
        .status-message td {
            text-align: center;
            color: #6b7280;
            padding: 1rem;
            font-style: italic;
        }
    </style>
</head>

<body class="antialiased">

    <header class="w-full fixed top-0 left-0 right-0 z-40 bg-white bg-opacity-80 backdrop-blur-sm shadow-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center p-3 md:p-4">
            <a href="index.html" class="flex items-center space-x-2">
                <img class="max-w-[70px]" src="Assets/petralogo.png" alt="Petra Logo">
                <span class="text-xl font-semibold text-primary-700 hidden sm:inline">
                    <img src="Assets/Action Fest 3 PNG-01.png" alt="Action Fest logo" class="h-16 md:h-20 w-auto">
                </span>
            </a>
            <nav class="flex items-center space-x-2">
                <a href="index.html" class="btn btn-primary p-2 home-button-icon" aria-label="Go to Homepage">
                    <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" d="M11.293 3.293a1 1 0 0 1 1.414 0l6 6 2 2a1 1 0 0 1-1.414 1.414L19 12.414V19a2 2 0 0 1-2 2h-3a1 1 0 0 1-1-1v-3h-2v3a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2v-6.586l-.293.293a1 1 0 0 1-1.414-1.414l2-2 6-6Z" clip-rule="evenodd" />
                    </svg>
                </a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 relative z-10">
        <div class="max-w-5xl mx-auto bg-white p-6 sm:p-8 lg:p-10 rounded-lg shadow-xl">

            <section class="mb-8 border-b border-gray-200 pb-6">
                <h1 class="text-3xl font-bold text-primary-700 text-center">Souvenir Recipient List</h1>
            </section>

            <section class="mb-8">
                <div class="table-container">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>School</th>
                                <th>Category</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="souvenir-list-body" class="bg-white divide-y divide-gray-200">
                            <tr class="status-message">
                                <td colspan="5">Loading recipient list...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Click 'Done' to mark as completed and move to bottom.</p>
            </section>

            <div class="mt-12 text-center text-sm text-gray-500 border-t border-gray-200 pt-6">
                <p>Need help? <a href="https://wa.me/+6282336138077" target="_blank" rel="noopener noreferrer" class="link-primary">Contact Support</a>.</p>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('souvenir-list-body');

            // --- CONFIGURATION ---
            // Key used to store the recipient list array (original structure) in localStorage
            const storageKey = "souvenirRecipients"; // <<< YOU CAN ADJUST THIS KEY NAME IF NEEDED

            // Netlify Function endpoint to GET the initial list of ALL souvenir recipients
            // This function should return the data in the *original* potentially grouped format.
            const initialDataEndpoint = "/.netlify/functions/getSouvenirList"; // <<< CREATE THIS NETLIFY FUNCTION

            // Netlify Function endpoint to POST an update for a SINGLE recipient's status
            // This function expects a JSON body like: { id: "unique_individual_id", status: true }
            const updateStatusEndpoint = "/.netlify/functions/markSouvenirDone/"; // <<< CREATE THIS NETLIFY FUNCTION
            // --- END CONFIGURATION ---

            // --- Check if table body exists ---
            if (!tableBody) {
                console.error("Critical Error: Table body element #souvenir-list-body not found. Script cannot run.");
                return; // Stop script execution if the essential table body is missing
            }

            // --- Helper Function to Flatten Grouped Data into Individual Recipient List ---
            // Handles mixed arrays containing individual objects and group objects.
            function flattenRecipientData(groupedData) {
                const flatList = [];
                if (!Array.isArray(groupedData)) {
                    console.error("Data error: Expected an array for flattening, received:", groupedData);
                    return flatList; // Return empty if data is invalid
                }

                groupedData.forEach((item, index) => {
                    if (!item || typeof item !== 'object') {
                        console.warn(`Skipping invalid item at index ${index}:`, item);
                        return;
                    }

                    if (item.members && Array.isArray(item.members)) {
                        item.members.forEach((member, memberIndex) => {
                            const memberId = member ? member.memberId : null;
                            if (!memberId) {
                                console.warn(`Skipping member without 'memberId' in group ${item.groupId || `at index ${index}`}, member index ${memberIndex}:`, member);
                                return;
                            }
                            const isGiven = item.status;

                            flatList.push({
                                id: memberId,
                                name: member.name || 'N/A',
                                school: item.school || 'N/A',
                                category_competition: item.category_competition || 'N/A',
                                souvenirGiven: isGiven,
                            });
                        });
                    } else if (item.id) {
                        const individualId = item.id;
                        flatList.push({
                            id: individualId,
                            name: item.name || 'N/A',
                            school: item.school || 'N/A',
                            category_competition: item.category_competition || 'N/A',
                            souvenirGiven: item.status,
                        });
                    } else {
                        console.warn(`Skipping item at index ${index} with unknown structure:`, item);
                    }
                });
                return flatList;
            }
            // --- Function to Update Original Grouped Data Structure in localStorage ---
            // Finds the correct item (group or individual) and updates the status for the specific individualId.
            function updateLocalStorageState(individualId, newStatus) {
                let originalData = [];
                

                try {
                    const storedData = localStorage.getItem(storageKey);
                    if (storedData) {
                        originalData = JSON.parse(storedData);
                        if (!Array.isArray(originalData)) {
                            console.warn("localStorage data is not an array. Resetting.");
                            originalData = [];
                        }
                    }
                } catch (e) {
                    console.error("Error accessing/parsing localStorage:", e);
                    alert("Error accessing local storage. Data might not be saved.");
                    return false; // Indicate failure
                }

                
                let updated = false;

                originalData.forEach(item => {
                    console.log(item.id)
                    if (item.id == individualId) {
                        item.status = newStatus;
                        updated = true;
                    } 
                });

                if (updated) {
                    try {
                        localStorage.setItem(storageKey, JSON.stringify(originalData));
                        return true; // Indicate success
                    } catch (e) {
                        console.error("Error saving to localStorage:", e);
                        alert("Error saving local data. Changes might not persist.");
                        return false; // Indicate failure
                    }
                } else {
                    console.warn(`Could not find individualId ${individualId} in localStorage.`);
                    return false; // Indicate failure
                }
            }

            // --- Function to Render the Table from Flattened Data ---
            function renderTable(flatRecipientList) {
                if (!tableBody) return;

                tableBody.innerHTML = '';

                if (!flatRecipientList || flatRecipientList.length === 0) {
                    tableBody.innerHTML = '<tr class="status-message"><td colspan="5">No recipients found.</td></tr>';
                    return;
                }

                flatRecipientList.sort((a, b) => {
                    if (a.souvenirGiven !== b.souvenirGiven) {
                        return a.souvenirGiven ? 1 : -1;
                    }
                    // Konversi nilai id ke string sebelum membandingkan
                    const idA = String(a.id || '');
                    const idB = String(b.id || '');
                    return idA.localeCompare(idB);
                });

                flatRecipientList.forEach(recipient => {
                    const row = document.createElement('tr');
                    row.dataset.recipientId = recipient.id;

                    const isDone = recipient.souvenirGiven;

                    if (isDone) {
                        row.classList.add('row-done');
                    }

                    const idCell = document.createElement('td');
                    idCell.textContent = recipient.id || 'N/A';
                    const nameCell = document.createElement('td');
                    nameCell.textContent = recipient.name || 'N/A';
                    const schoolCell = document.createElement('td');
                    schoolCell.textContent = recipient.school || 'N/A';
                    const categoryCell = document.createElement('td');
                    categoryCell.textContent = recipient.category_competition || 'N/A';

                    const actionCell = document.createElement('td');
                    actionCell.classList.add('text-center');
                    const button = document.createElement('button');
                    button.classList.add('btn', isDone ? 'btn-disabled' : 'btn-primary', 'btn-done-souvenir');
                    button.dataset.recipientId = recipient.id;
                    button.disabled = isDone;
                    button.setAttribute('aria-pressed', isDone.toString());
                    button.setAttribute('aria-label', `Mark ${recipient.name || 'recipient'} as ${isDone ? 'Completed' : 'Done'}`);
                    button.textContent = isDone ? 'Completed' : 'Done';

                    actionCell.appendChild(button);

                    row.appendChild(idCell);
                    row.appendChild(nameCell);
                    row.appendChild(schoolCell);
                    row.appendChild(categoryCell);
                    row.appendChild(actionCell);

                    tableBody.appendChild(row);
                });
            }

            // --- Function to Fetch Initial Data from the Server ---
            async function fetchInitialData() {
                if (!tableBody) return;
                tableBody.innerHTML = '<tr class="status-message"><td colspan="5">Fetching recipient list from server...</td></tr>';

                try {
                    const response = await fetch(initialDataEndpoint);

                    if (!response.ok) {
                        let errorText = `Status: ${response.status}. Could not retrieve details.`;
                        try {
                            const bodyText = await response.text();
                            if (!bodyText.toLowerCase().includes('<html')) {
                                errorText = bodyText || errorText;
                            }
                        } catch (_) {}
                        throw new Error(`Server error - ${errorText}`);
                    }

                    const originalData = await response.json();

                    if (!Array.isArray(originalData)) {
                        console.error("Invalid data format received from server: Expected an array.", originalData);
                        throw new Error("Invalid data format received from server.");
                    }

                    console.log(`Successfully fetched ${originalData.length} records from server.`);

                    try {
                        localStorage.setItem(storageKey, JSON.stringify(originalData));
                    } catch (e) {
                        console.error("Error saving fetched data to localStorage:", e);
                        alert("Warning: Could not save the latest data locally. Using fetched data for now, but state might not persist if page is closed.");
                    }

                    const flatList = flattenRecipientData(originalData);
                    renderTable(flatList);

                } catch (error) {
                    console.error("Failed to fetch initial data:", error);
                    tableBody.innerHTML = `<tr class="status-message"><td colspan="5">Error loading data: ${error.message}. Trying local data...</td></tr>`;

                    let localData = [];
                    try {
                        const localDataString = localStorage.getItem(storageKey);
                        localData = localDataString ? JSON.parse(localDataString) : [];
                        if (!Array.isArray(localData)) {
                            console.warn("Local storage data is not an array, resetting.");
                            localData = [];
                        }
                    } catch (localError) {
                        console.error("Failed to parse local data after fetch error:", localError);
                        localData = [];
                    }

                    const flatList = flattenRecipientData(localData);
                    setTimeout(() => {
                        if (flatList.length > 0) {
                            console.log("Rendering data from localStorage fallback.");
                            renderTable(flatList);
                        } else {
                            tableBody.innerHTML = `<tr class="status-message"><td colspan="5">Error loading data. Could not fetch from server or load local data.</td></tr>`;
                        }
                    }, 1500);
                }
            }

            // --- Event Listener for Clicking "Done" Buttons (using Event Delegation) ---
            tableBody.addEventListener('click', function(event) {
                const button = event.target.closest('.btn-done-souvenir');

                if (button && !button.disabled) {
                    const individualId = button.dataset.recipientId;
                    const row = button.closest('tr');

                    if (!row || !individualId) {
                        console.error("Could not find row or individualId for the clicked button.", button);
                        return;
                    }

                    const backendUpdateData = {
                        id: individualId,
                        status: true
                    };

                    button.disabled = true;
                    button.textContent = 'Saving...';

                    fetch(updateStatusEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(backendUpdateData)
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    let detail = text || 'No details';
                                    try {
                                        detail = JSON.parse(text).message || detail;
                                    } catch (_) {}
                                    throw new Error(`Server error: ${response.status} ${response.statusText} - ${detail}`);
                                });
                            }
                            const contentType = response.headers.get("content-type");
                            if (contentType?.includes("application/json")) {
                                return response.json();
                            } else {
                                return response.text();
                            }
                        })
                        .then(data => {
                            console.log('Backend update successful for individual:', individualId, data);

                            const localStorageUpdated = updateLocalStorageState(individualId, true);

                            if (localStorageUpdated) {
                                row.classList.add('row-done');
                                button.textContent = 'Completed';
                                button.classList.remove('btn-primary');
                                button.classList.add('btn-disabled');
                                button.setAttribute('aria-pressed', 'true');
                                tableBody.appendChild(row);

                            } else {
                                console.error("CRITICAL: Backend updated but localStorage failed to save for ID:", individualId);
                                alert(`Error: Status updated on server, but local data could not be saved for ${individualId}. The change might be lost on refresh. Please report this issue.`);
                                button.textContent = 'Done';
                                button.disabled = false;
                                button.classList.remove('btn-disabled');
                                button.classList.add('btn-primary');
                                button.setAttribute('aria-pressed', 'false');
                            }
                        })
                        .catch(error => {
                            console.error(`Failed to update backend for individual ${individualId}:`, error);
                            alert(`Failed to mark souvenir as done for ${individualId}. Error: ${error.message}. Please check connection or try again.`);
                            button.disabled = false;
                            button.textContent = 'Done';
                        });
                }
            });

            // --- Initial Data Fetch and Table Render ---
            fetchInitialData();
        });
    </script>
</body>

</html>